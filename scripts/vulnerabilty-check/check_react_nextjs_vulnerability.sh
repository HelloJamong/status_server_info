#!/bin/bash

# React Server Components ì·¨ì•½ì  ì ê²€ ìŠ¤í¬ë¦½íŠ¸
# CVE-2025-55182, CVE-2025-66478
# ìˆœìˆ˜ bashë¡œ ì‘ë™ (node.js, jq ë¶ˆí•„ìš”)

echo "=================================================="
echo "React/Next.js ì·¨ì•½ì  ì ê²€ ìŠ¤í¬ë¦½íŠ¸"
echo "CVE-2025-55182, CVE-2025-66478"
echo "ì ê²€ ì‹œì‘ ì‹œê°„: $(date)"
echo "=================================================="
echo ""

# ê²°ê³¼ ì €ì¥ íŒŒì¼
REPORT_FILE="vulnerability_check_report_$(date +%Y%m%d_%H%M%S).txt"

# ë¡œê·¸ í•¨ìˆ˜
log_result() {
    echo "$1" | tee -a "$REPORT_FILE"
}

log_result "=================================================="
log_result "React/Next.js ì·¨ì•½ì  ì ê²€ ë³´ê³ ì„œ"
log_result "ì ê²€ ì‹œê°„: $(date)"
log_result "í˜¸ìŠ¤íŠ¸ëª…: $(hostname)"
log_result "=================================================="
log_result ""

# JSONì—ì„œ ì˜ì¡´ì„± ì¶”ì¶œ í•¨ìˆ˜ (ìˆœìˆ˜ bash)
extract_dependencies() {
    local file="$1"
    local deps=""

    # JSONì—ì„œ dependenciesì™€ devDependencies ì„¹ì…˜ ì¶”ì¶œ
    local in_deps=0
    local in_dev_deps=0
    local brace_count=0

    while IFS= read -r line; do
        # dependencies ì„¹ì…˜ ì‹œì‘
        if echo "$line" | grep -q '"dependencies"[[:space:]]*:[[:space:]]*{'; then
            in_deps=1
            brace_count=1
            continue
        fi

        # devDependencies ì„¹ì…˜ ì‹œì‘
        if echo "$line" | grep -q '"devDependencies"[[:space:]]*:[[:space:]]*{'; then
            in_dev_deps=1
            brace_count=1
            continue
        fi

        # ì„¹ì…˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
        if [ $in_deps -eq 1 ] || [ $in_dev_deps -eq 1 ]; then
            # ì¤‘ê´„í˜¸ ì¹´ìš´íŒ…
            brace_count=$((brace_count + $(echo "$line" | grep -o '{' | wc -l)))
            brace_count=$((brace_count - $(echo "$line" | grep -o '}' | wc -l)))

            # React ê´€ë ¨ íŒ¨í‚¤ì§€ ì°¾ê¸°
            if echo "$line" | grep -qE '"(react-server-dom-webpack|react-server-dom-parcel|react-server-dom-turbopack|next)"'; then
                # íŒ¨í‚¤ì§€ëª…ê³¼ ë²„ì „ ì¶”ì¶œ
                pkg_name=$(echo "$line" | sed -n 's/.*"\([^"]*\)".*/\1/p' | head -1)
                pkg_version=$(echo "$line" | sed -n 's/.*:[[:space:]]*"\([^"]*\)".*/\1/p' | sed 's/[,}]//g' | tr -d ' ')

                if [ -n "$pkg_name" ] && [ -n "$pkg_version" ]; then
                    deps="${deps}${pkg_name}: ${pkg_version}"$'\n'
                fi
            fi

            # ì„¹ì…˜ ì¢…ë£Œ
            if [ $brace_count -le 0 ]; then
                in_deps=0
                in_dev_deps=0
            fi
        fi
    done < "$file"

    echo "$deps"
}

# ë²„ì „ ì¶”ì¶œ í•¨ìˆ˜ (^, ~, >=, >, < ë“±ì˜ ë²”ìœ„ í‘œì‹œì ì œê±°)
extract_version() {
    local version_string="$1"
    # ë²”ìœ„ í‘œì‹œìì™€ ê³µë°± ì œê±°, ìˆœìˆ˜ ë²„ì „ ë²ˆí˜¸ë§Œ ì¶”ì¶œ
    echo "$version_string" | sed 's/[^0-9.].*//g; s/^[~^>=<]*//g'
}

# ë²„ì „ ë¹„êµ í•¨ìˆ˜
version_compare() {
    local version="$1"
    local pattern="$2"

    # ë²„ì „ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
    version=$(extract_version "$version")

    # ì •ê·œì‹ìœ¼ë¡œ ë¹„êµ
    if [[ "$version" =~ $pattern ]]; then
        return 0
    else
        return 1
    fi
}

log_result "[1] Node.js í”„ë¡œì íŠ¸ ê²€ìƒ‰ (package.json íŒŒì¼ ê¸°ì¤€)"
log_result "ê²€ìƒ‰ ê²½ë¡œ: /home, /var/www, /opt, /usr/local"
log_result ""

# package.json íŒŒì¼ ì°¾ê¸° (ì¼ë°˜ì ì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê²½ë¡œ)
PACKAGE_JSON_FILES=$(find /home /var/www /opt /usr/local -name "package.json" 2>/dev/null)

if [ -z "$PACKAGE_JSON_FILES" ]; then
    log_result "âœ— package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    log_result "  í”„ë¡œì íŠ¸ê°€ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ê²½ë¡œì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    exit 0
fi

PROJECT_COUNT=$(echo "$PACKAGE_JSON_FILES" | wc -l)
log_result "âœ“ ì´ $PROJECT_COUNT ê°œì˜ í”„ë¡œì íŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."
log_result ""

# ê° í”„ë¡œì íŠ¸ë³„ ì·¨ì•½ì  ì ê²€
VULNERABLE_COUNT=0
SAFE_COUNT=0
PROJECT_NUM=0

while IFS= read -r PACKAGE_FILE; do
    PROJECT_NUM=$((PROJECT_NUM + 1))
    PROJECT_DIR=$(dirname "$PACKAGE_FILE")

    log_result "------------------------------------------------"
    log_result "í”„ë¡œì íŠ¸ #$PROJECT_NUM: $PROJECT_DIR"
    log_result "------------------------------------------------"

    # package.json íŒŒì¼ì´ ì½ì„ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
    if [ ! -r "$PACKAGE_FILE" ]; then
        log_result "âœ— package.json íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¶Œí•œ ë¬¸ì œ)"
        log_result ""
        continue
    fi

    # ì˜ì¡´ì„± ì¶”ì¶œ (ìˆœìˆ˜ bash)
    REACT_DEPS=$(extract_dependencies "$PACKAGE_FILE")

    if [ -z "$REACT_DEPS" ]; then
        log_result "âœ“ React Server Components ë˜ëŠ” Next.jsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        SAFE_COUNT=$((SAFE_COUNT + 1))
        log_result ""
        continue
    fi

    log_result "ë°œê²¬ëœ ì˜ì¡´ì„±:"
    echo "$REACT_DEPS" | while read -r line; do
        [ -n "$line" ] && log_result "  $line"
    done
    log_result ""

    # ì·¨ì•½ì  ì—¬ë¶€ íŒë‹¨
    IS_VULNERABLE=0

    # react-server-dom-webpack ì ê²€
    if echo "$REACT_DEPS" | grep -q "react-server-dom-webpack"; then
        VERSION=$(echo "$REACT_DEPS" | grep "react-server-dom-webpack" | sed 's/.*: //; s/"//g; s/,//g')
        VERSION=$(extract_version "$VERSION")
        log_result "âš  react-server-dom-webpack ë°œê²¬: $VERSION"

        if version_compare "$VERSION" "^19\.0$" || \
           version_compare "$VERSION" "^19\.1\.[01]$" || \
           version_compare "$VERSION" "^19\.2\.0$"; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜: 19.0.1, 19.1.2, ë˜ëŠ” 19.2.1 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            IS_VULNERABLE=1
        fi
    fi

    # react-server-dom-parcel ì ê²€
    if echo "$REACT_DEPS" | grep -q "react-server-dom-parcel"; then
        VERSION=$(echo "$REACT_DEPS" | grep "react-server-dom-parcel" | sed 's/.*: //; s/"//g; s/,//g')
        VERSION=$(extract_version "$VERSION")
        log_result "âš  react-server-dom-parcel ë°œê²¬: $VERSION"

        if version_compare "$VERSION" "^19\.0$" || \
           version_compare "$VERSION" "^19\.1\.[01]$" || \
           version_compare "$VERSION" "^19\.2\.0$"; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜: 19.0.1, 19.1.2, ë˜ëŠ” 19.2.1 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            IS_VULNERABLE=1
        fi
    fi

    # react-server-dom-turbopack ì ê²€
    if echo "$REACT_DEPS" | grep -q "react-server-dom-turbopack"; then
        VERSION=$(echo "$REACT_DEPS" | grep "react-server-dom-turbopack" | sed 's/.*: //; s/"//g; s/,//g')
        VERSION=$(extract_version "$VERSION")
        log_result "âš  react-server-dom-turbopack ë°œê²¬: $VERSION"

        if version_compare "$VERSION" "^19\.0$" || \
           version_compare "$VERSION" "^19\.1\.[01]$" || \
           version_compare "$VERSION" "^19\.2\.0$"; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜: 19.0.1, 19.1.2, ë˜ëŠ” 19.2.1 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            IS_VULNERABLE=1
        fi
    fi

    # Next.js ì ê²€
    if echo "$REACT_DEPS" | grep -q "next"; then
        VERSION=$(echo "$REACT_DEPS" | grep "^next:" | sed 's/.*: //; s/"//g; s/,//g')
        ORIGINAL_VERSION="$VERSION"
        VERSION=$(extract_version "$VERSION")
        log_result "âš  Next.js ë°œê²¬: $VERSION"

        # ì·¨ì•½í•œ ë²„ì „ í™•ì¸
        if version_compare "$VERSION" "^15\.0\.[0-4]$" || \
           version_compare "$VERSION" "^15\.1\.[0-8]$" || \
           version_compare "$VERSION" "^15\.2\.[0-5]$" || \
           version_compare "$VERSION" "^15\.3\.[0-5]$" || \
           version_compare "$VERSION" "^15\.4\.[0-7]$" || \
           version_compare "$VERSION" "^15\.5\.[0-6]$" || \
           version_compare "$VERSION" "^16\.0\.[0-6]$"; then
            log_result "  ğŸ”´ ì·¨ì•½í•œ ë²„ì „ì…ë‹ˆë‹¤!"
            log_result "  ê¶Œì¥ ì¡°ì¹˜:"

            if version_compare "$VERSION" "^15\.0"; then
                log_result "    - 15.0.5 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif version_compare "$VERSION" "^15\.1"; then
                log_result "    - 15.1.9 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif version_compare "$VERSION" "^15\.2"; then
                log_result "    - 15.2.6 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif version_compare "$VERSION" "^15\.3"; then
                log_result "    - 15.3.6 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif version_compare "$VERSION" "^15\.4"; then
                log_result "    - 15.4.8 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif version_compare "$VERSION" "^15\.5"; then
                log_result "    - 15.5.7 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            elif version_compare "$VERSION" "^16\.0"; then
                log_result "    - 16.0.7 ì´ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸"
            fi
            IS_VULNERABLE=1
        elif version_compare "$VERSION" "^14\.3\."; then
            # Canary ë²„ì „ í™•ì¸
            if echo "$ORIGINAL_VERSION" | grep -q "canary"; then
                log_result "  ğŸ”´ Canary ë²„ì „ìœ¼ë¡œ ì·¨ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                log_result "  ê¶Œì¥ ì¡°ì¹˜: 14.x ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ"
                IS_VULNERABLE=1
            fi
        fi
    fi

    if [ $IS_VULNERABLE -eq 1 ]; then
        VULNERABLE_COUNT=$((VULNERABLE_COUNT + 1))
        log_result ""
        log_result "ğŸ”´ ì´ í”„ë¡œì íŠ¸ëŠ” ì·¨ì•½ì ì— ë…¸ì¶œë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
    else
        SAFE_COUNT=$((SAFE_COUNT + 1))
        log_result ""
        log_result "âœ“ ì´ í”„ë¡œì íŠ¸ëŠ” ì•ˆì „í•œ ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤."
    fi

    log_result ""

done <<< "$PACKAGE_JSON_FILES"

# 5. ìµœì¢… ìš”ì•½
log_result "=================================================="
log_result "ì ê²€ ê²°ê³¼ ìš”ì•½"
log_result "=================================================="
log_result "ì´ í”„ë¡œì íŠ¸ ìˆ˜: $PROJECT_COUNT"
log_result "ì·¨ì•½í•œ í”„ë¡œì íŠ¸: $VULNERABLE_COUNT"
log_result "ì•ˆì „í•œ í”„ë¡œì íŠ¸: $SAFE_COUNT"
log_result ""

if [ $VULNERABLE_COUNT -gt 0 ]; then
    log_result "âš ï¸  ê²½ê³ : ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
    log_result ""
    log_result "ì¡°ì¹˜ ë°©ë²•:"
    log_result "1. ê° í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
    log_result "2. package.json íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ì•ˆì „í•œ ë²„ì „ìœ¼ë¡œ ë³€ê²½"
    log_result "3. npm install ë˜ëŠ” npm update ì‹¤í–‰"
    log_result "4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘"
    log_result ""
    log_result "ì°¸ê³ :"
    log_result "- CVE-2025-55182: React Server Components RCE ì·¨ì•½ì "
    log_result "- https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components"
    log_result "- https://nvd.nist.gov/vuln/detail/CVE-2025-55182"
else
    log_result "âœ“ ëª¨ë“  í”„ë¡œì íŠ¸ê°€ ì•ˆì „í•©ë‹ˆë‹¤."
fi

log_result ""
log_result "ë³´ê³ ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: $REPORT_FILE"
log_result "ì ê²€ ì¢…ë£Œ ì‹œê°„: $(date)"
log_result "=================================================="

echo ""
echo "ë³´ê³ ì„œ íŒŒì¼: $REPORT_FILE"
